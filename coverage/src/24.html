<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/Users/jt/repos/FetchRewardsTakeHome/FetchRewardsTakeHome/Business/Services/TransactionService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using FetchRewardsTakeHome.Business.Repositories.Exceptions;
using FetchRewardsTakeHome.Business.Repositories.Models;
using FetchRewardsTakeHome.Business.Repositories.Payer;
using FetchRewardsTakeHome.Business.Repositories.Points;

namespace FetchRewardsTakeHome.Business.Services;

public class TransactionService : ITransactionService
{
    private readonly ILogger&lt;TransactionService&gt; _logger;
    private readonly IPayerRepository _payerRepository;
    private readonly IPointsRepository _pointsRepository;

    public TransactionService(
        ILogger&lt;TransactionService&gt; logger,
        IPointsRepository pointsRepository,
        IPayerRepository payerRepository)
    {
        _logger = logger;
        _pointsRepository = pointsRepository;
        _payerRepository = payerRepository;
    }

    public async Task&lt;PointsModel&gt; AddTransaction(PointsModel points)
    {
        _logger.LogDebug(&quot;Attempting to insert transaction of {Points} for {Payer}&quot;, points.Points, points.Payer);
        PayerModel payer;
        try
        {
            payer = await _payerRepository.FindPayerByName(points.Payer);
        }
        catch (PayerNotFound e)
        {
            payer = await _payerRepository.InsertNewPayer(new PayerModel(points.Payer));
        }
        var returnedTransaction = await _pointsRepository.InsertTransaction(points);
        await _payerRepository.AddPoints(payer, returnedTransaction.Points);
        return returnedTransaction;
    }

    public async Task&lt;PointsModel&gt; LookupTransaction(Guid guid)
    {
        return await _pointsRepository.FindTransaction(guid);
    }

    public async Task&lt;List&lt;PointsModel&gt;&gt; Spend(int points)
    {
        var transactions = await _pointsRepository.GetSortedTransactions();
        var remainingPoints = Math.Abs(points);
        var payeePointsMap = new Dictionary&lt;string, int&gt;();

        for (int i = 0; i &lt; transactions.Count; i++)
        {
            var transaction = transactions[i];
            var payer = transaction.Payer;
            if (!payeePointsMap.ContainsKey(transaction.Payer))
            {
                payeePointsMap[payer] = 0;
            }

            var pointsToAdd = transaction.Points;
            if (transaction.Points &gt;= 0)
            {
                pointsToAdd = Math.Min(remainingPoints, transaction.Points);
            }
            payeePointsMap[payer] += pointsToAdd;
            remainingPoints -= pointsToAdd;
            if (remainingPoints == 0)
            {
                break;
            }
        }
        
        if (remainingPoints != 0)
        {
            throw new NotEnoughPoints(points);
        }

        var transactionToRedeem = new List&lt;PointsModel&gt;();
        foreach (var key in payeePointsMap.Keys)
        {
            transactionToRedeem.Add(new PointsModel(key, payeePointsMap[key] * -1, DateTime.Now));
        }

        return await AddTransactions(transactionToRedeem);
    }

    private async Task&lt;List&lt;PointsModel&gt;&gt; AddTransactions(List&lt;PointsModel&gt; transactions)
    {
        var returnList = new List&lt;PointsModel&gt;();
        foreach (var transaction in transactions)
        {
            returnList.Add(await AddTransaction(transaction));
        }
        return returnList;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,5,17,42,1],[18,5,18,6,1],[19,9,19,26,1],[20,9,20,46,1],[21,9,21,44,1],[22,5,22,6,1],[25,5,25,6,1],[26,9,26,115,1],[29,9,29,10,1],[30,13,30,74,1],[31,9,31,10,1],[32,9,32,32,1],[33,9,33,10,1],[34,13,34,89,1],[35,9,35,10,1],[36,9,36,85,1],[37,9,37,77,1],[38,9,38,36,1],[39,5,39,6,1],[42,5,42,6,1],[43,9,43,62,1],[44,5,44,6,1],[47,5,47,6,1],[48,9,48,76,1],[49,9,49,48,1],[50,9,50,60,1],[52,14,52,23,1],[52,25,52,47,1],[52,49,52,52,1],[53,9,53,10,1],[54,13,54,47,1],[55,13,55,43,1],[56,13,56,64,1],[57,13,57,14,1],[58,17,58,43,1],[59,13,59,14,1],[61,13,61,50,1],[62,13,62,41,1],[63,13,63,14,1],[64,17,64,77,1],[65,13,65,14,1],[66,13,66,50,1],[67,13,67,44,1],[68,13,68,38,1],[69,13,69,14,1],[70,17,70,23,1],[72,9,72,10,1],[74,9,74,34,1],[75,9,75,10,1],[76,13,76,47,1],[79,9,79,59,1],[80,9,80,16,1],[80,18,80,25,1],[80,26,80,28,1],[80,29,80,48,1],[81,9,81,10,1],[82,13,82,99,1],[83,9,83,10,1],[85,9,85,59,1],[86,5,86,6,1],[89,5,89,6,1],[90,9,90,50,1],[91,9,91,16,1],[91,18,91,33,1],[91,34,91,36,1],[91,37,91,49,1],[92,9,92,10,1],[93,13,93,63,1],[94,9,94,10,1],[95,9,95,27,1],[96,5,96,6,1]]);
    </script>
  </body>
</html>